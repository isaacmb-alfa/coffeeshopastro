---
export const prerender = false;
import PostCategories from "@/components/blog/PostCategories.astro";
import PostMeta from "@/components/blog/PostMeta.astro";
import { getBlogPostBySlug } from "@/hooks/apiresponse";
import Layout from "@/layouts/Layout.astro";
import { Picture } from "astro:assets";

const { slug } = Astro.params;
if (!slug) {
  throw new Error("No slug provided");
}

interface ImageContent {
  url: string;
  width: number;
  height: number;
}

interface BlogPost {
  id: number;
  title: string;
  date: string;
  full: ImageContent;
  content: string;
  thumbnail: ImageContent;
  large: ImageContent;
  medium_large: ImageContent;
  category_details: Array<{
    id: number;
    name: string;
    slug: string;
    link: string;
  }>;
}

// getBlogPostBySlug devuelve un array, necesitamos el primer elemento
let postArray: BlogPost[];
let post: BlogPost;
let title: string;
let url: string;
let width: number;
let height: number;
let content: string;
let date: string;
let category_details: Array<{
  id: number;
  name: string;
  slug: string;
  link: string;
}>;

try {
  postArray = (await getBlogPostBySlug(slug)) as BlogPost[];
  post = postArray[0];

  if (!post || postArray.length === 0) {
    return Astro.redirect('/404');
  }

  ({ title, full: { url, width, height }, content, date, category_details } = post);
//   console.log(post);
} catch (error) {
  // Captura errores del hook como "No data found for endpoint" o "Invalid blog data format"
  console.error(`Error loading blog post "${slug}":`, error);
  return Astro.redirect('/404');
}
---

<Layout title={title} subtitle={title} bgImage={url} opcionalClass={'max-w-4xl mx-auto lg:pb-5'} >
  <article class="space-y-5 max-w-4xl mx-auto">
    <PostMeta date={date} />
        {
      category_details &&
        category_details.map((category, index) => (
          <PostCategories category={category} index={index} />
        ))
    }
      <Picture
    src={url}
    alt={`Imagen de ${title}`}
    width={width}
    height={height}
    formats={["avif", "webp"]}
    class="w-full"
  />
  <div set:html={content} class="prose text-lg space-y-3 mt-5" />
  </article>
</Layout>
